<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Knowear</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #f5f3ff, #ede9fe);
      text-align: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    }
    .icon { font-size: 48px; margin-bottom: 16px; }
    h1 { color: #1a1a1a; font-size: 24px; margin-bottom: 8px; }
    p { color: #666; font-size: 16px; line-height: 1.5; }
    .btn {
      display: inline-block;
      margin-top: 16px;
      padding: 12px 24px;
      background: #7c3aed;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
    }
    .btn:hover { background: #6d28d9; }
    .small { font-size: 13px; color: #999; margin-top: 16px; }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #e5e7eb;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { color: #dc2626; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="card">
    <!-- Loading state -->
    <div id="loading">
      <div class="spinner"></div>
      <h1>Processing Reset Link...</h1>
      <p>Please wait while we verify your password reset link.</p>
    </div>

    <!-- Success: Redirect to app -->
    <div id="success" class="hidden">
      <div class="icon">&#128273;</div>
      <h1>Reset Your Password</h1>
      <p>Click below to open the Knowear app and set your new password.</p>
      <a id="app-link" class="btn" href="#">Open Knowear App</a>
      <p class="small">If the app doesn't open, make sure you have Knowear installed.</p>
    </div>

    <!-- Error state -->
    <div id="error" class="hidden">
      <div class="icon">&#9888;&#65039;</div>
      <h1 class="error">Link Expired</h1>
      <p>This password reset link has expired or is invalid.</p>
      <p>Please request a new reset link from the app.</p>
    </div>
  </div>

  <script>
    (function() {
      var loading = document.getElementById('loading');
      var success = document.getElementById('success');
      var error = document.getElementById('error');
      var appLink = document.getElementById('app-link');

      // Get the full URL including hash fragment
      var search = window.location.search;
      var hash = window.location.hash;

      // Supabase sends tokens either as query params or hash fragment
      // For PKCE flow, it sends a ?code= parameter
      var params = new URLSearchParams(search);
      var hashParams = new URLSearchParams(hash.substring(1));

      var code = params.get('code');
      var accessToken = hashParams.get('access_token');
      var refreshToken = hashParams.get('refresh_token');
      var type = hashParams.get('type') || params.get('type');
      var errorParam = hashParams.get('error') || params.get('error');

      // Check for errors
      if (errorParam) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        return;
      }

      // Build deep link for the mobile app
      var deepLink = 'knowear://reset-password';
      if (code) {
        deepLink += '?code=' + encodeURIComponent(code);
      } else if (accessToken) {
        deepLink += '#access_token=' + encodeURIComponent(accessToken);
        if (refreshToken) {
          deepLink += '&refresh_token=' + encodeURIComponent(refreshToken);
        }
        if (type) {
          deepLink += '&type=' + encodeURIComponent(type);
        }
      } else {
        // No valid tokens found
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        return;
      }

      // Show success state with link to open app
      loading.classList.add('hidden');
      success.classList.remove('hidden');
      appLink.href = deepLink;

      // Auto-try to open the app via deep link
      window.location.href = deepLink;
    })();
  </script>
</body>
</html>
